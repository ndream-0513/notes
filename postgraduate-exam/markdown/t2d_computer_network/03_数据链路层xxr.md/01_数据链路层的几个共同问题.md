下面的内容只考虑分组怎样从一台主机传送到另一台主机，不经过路由器的转发；

## 3.1 数据链路层的共同问题

### 3.1.1 数据链路和帧

- 链路：一个节点到相邻节点的一段物理链路；
- 数据链路：即在链路的基础上加上了必要的通信协议；
- 帧：链路层传输数据的最小单位，其中的数据部分为网络层的IP数据报；

点对点信道的数据链路层在进行通信时的主要步骤：

- 节点A的链路层把网络层交下来的IP数据报添加首部和尾部封装成帧(**封装成帧**)；
- 节点A把封装好的帧发送给节点B的链路层(**透明传输**);
- 若节点B的链路层收到的帧无比特差错，则从收到的帧中提取出IP数据报交给上面的网络层；否则丢弃这个帧(**差错检测**)；

### 3.1.2 封装成帧

封装成帧的过程：链路层收到网络层的IP数据报后，将IP数据报作为帧的数据部分并在数据部分的前面和后面分别添加上首部和尾部，这样就构成了一个完整的帧；首部和尾部包括帧定界符(SOH 01H、EOT 04H)和一些必要的控制信息；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231027165823629.png" alt="image-20231027165823629" style="zoom:67%;" />

### 3.1.2 透明传输

- 当帧的数据部分是**文本文件时(ASCII码)**，数据部分不会出现SOH(Start Of Header 01H)、EOT(End Of Transimission, 04H)，无论数据部分是什么字符都可以直接传送给接收方的链路层，这样的传输就是**透明传输**；

- 当帧的数据部分是**非ASCII码的文本文件**时(图片、视频等)，数据部分中有可能会出现SOH、EOT，需要经过**字符填充**之后才能发送

  - 字符填充：
    - 发送端的链路层的数据部分如果出现SOH/EOT，则在SOH/EOT的前面插入一个转义字符ESC；接收端的链路层在把数据送往网络层之前删除插入的转义字符；
    - 如果数据部分出现ESC，则在ESC前面再插入一个ESC；因此，当接收端收到连续的两个转义字符时，就删除其中的前一个

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231027171021334.png" alt="image-20231027171021334" style="zoom: 50%;" />

### 3.1.3 差错检测

链路层一般使用循环冗余检验CRC检错技术(只提供检错，不提供纠错)，下面是**CRC**的一个**例子**：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231027171237076.png" alt="image-20231027171237076" style="zoom:67%;" />

- 最后的数据部分为101001001，接收方得到数据部分后，用P(除数)进行检验，如果数据部分/P的R(余数)为0，则说明未发生差错，可接受该帧

  > 接受不等于接收，无论数据是否受损接收方都会接收，只是受损的帧不被接受，直接丢弃了。因此可以得到“凡是接收端数据链路层接受的帧均无差错”

- **“无比特差错”不等于“无传输差错”**，还可能会出现失序、重复、丢失等情况；

- 通常，链路层不提供可靠传输，但是链路层也可以通过帧编号、确认和重传机制实现可靠传输，也有实现可靠传输的链路层协议HDLC，只不过现很少使用，有时，链路层会根据通信链路的质量来决定是否使用可靠传输：

  - 对于通信质量良好的有线传输链路：链路层向上不提供可靠传输服务，可靠传输服务由TCP提供；
  - 对于通信质量较差的无线传输链路：链路层向上提供可靠传输服务；



## 3.2 点对点协议PPP

PPP协议的两种应用：主机与ISP通信时所使用的链路层协议；广域网路由器之间的专用线路；

### 3.2.1 PPP协议的特点

**需满足的要求**：简单、分装成帧、透明性、支持多种网络层协议、支持多种类型链路、提供差错检测、可以检测连接状态、提供最大传输单元、网络层地址协商、数据压缩协商

> - 简单：接收方没收到一个帧就进行CRC检验，正确则接受，反之则丢弃
> - PPPoE是PPP协议能适应多种类型链路的一个例子，PPPoE是为宽带上网的主机使用的链路层协议，这个协议把PPP帧再封装在以太网帧中
> - 检测连接状态：检测里链路是否处于正常工作状态中
> - MTU是数据链路层的帧可以载荷的数据部分的最大长度，不是帧的总长度

**特点**：

- PPP不使用序号和确认机制，只保证无差错接受(CRC检验)，因而是不可靠服务；
- PPP只支持全双工的点对点链路，不支持多点线路；
- PPP的两端可以运行不同的网络层协议，但仍可以使用同一个PPP进行通信；
- PPP是面向字节的，所有PPP帧的长度都是整数倍字节长度；

### 3.2.2 PPP协议的帧格式

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231027174611077.png" alt="image-20231027174611077" style="zoom:67%;" />

> **PPP协议的组成**：一个用于建立、配置和测试数据链路连接的**链路控制协议(LCP)**；一套**网络控制协议(NCP)**，其中的每一个协议支持不同的网络层协议；一个将IP数据报封装到串行链路的方法；
>
> 由于PPP是点对点的，并不是总线形，因此无须使用CSMA/CD协议，因此没有最短帧长的限制，所以信息段为0~1500B，不超过1500B

为了实现透明传输，当信息字段出现7EH时，需要采取一些必要的措施进行处理；

- 当PPP使用**异步传输**(逐个字符地传送)时，**转义字符**定义为**7DH**，并使用**字节填充**：
  - 7EH → 7D5EH、7DH → 7D5DH
  - ASCII码控制字符，03H → 7D23H(03变为23，将控制变为非控制)
- 当PPP使用**同步传输**(一连串的比特连续传送)时(SONET/SDH)，使用**零比特填充**：
  - 在发送端，先扫描整个信息段，只要发现5个连续的1，则立即填入一个0；接收端收到一个帧时，先找到标志字段F以确定一个帧的边界，接着再使用硬件对其中的比特流进行扫描，每发现5个连续的1，就把这5个连续的1后的一个0删除；

### 3.2.3 PPP协议的工作状态

![image-20231028141736666](C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231028141736666.png)

> 只有经过LCP配置协商、NCP配置协商到达链路打开状态后，两个PPP端点才可以互相发送数据；在链路打开状态，两个PPP端点还可发送回送请求LCP分组和回送回答LCP分组，以检查链路的状态



## 3.3 局域网

局域网最主要的特点：网络为一个单位所有，且地理范围和站点数目均有限；局域网按网络拓扑进行分类可分为**星形网**、**环形网**和**总线网**；严格来说，以太网是指符合DIX Ethernet V2标准的局域网，但DIX Ethernet V2标准与IEEE802.3标准的差别很小，所以通常将符合802.3标准的局域网称为以太网；

**局域网≈以太网**，以太网的发展过程，**总线网→星形网**(逻辑上为总线网)，局域网之间使用共享信道实现一对多的通信，**共享信道**的实现一般有两种方法：

> - 静态划分信道：频分、时分、波分和码分复用
>
> - 动态媒体接入控制：随机接入、受控接入
>   - 随机接入：会产生碰撞，因此需要特定的协议进行调控，如**CSMA/CD**
>   - 受控接入：令牌环局域网、多点线路轮询

计算机通过**适配器**(PCMCIA卡/网卡)与局域网进行连接，适配器和局域网之间使用电缆或双绞线以串行方式进行痛惜，和计算机之间通过计算机主板的I/O总线以并行的方式进行通信，因此适配器需实现串行数据和并行数据之间的转换；**适配器中有处理器和ROM**，在接收和发送各种帧时，不使用计算机的CPU，可以实现和CPU的并行工作；计算机的硬件地址(**MAC地址**)就**存储于适配器之中**，计算机的软件地址(IP地址)存储于计算机的存储器之中；

### 3.3.1 CSMA/CD协议

以太网的特点：以太网只提供**不可靠的交付服务**；发送的数据都是用**曼彻斯特编码**；早期的以太网为总线形的网络，一条总线上，同一时间只允许一台计算机发送数据，但会出现多台计算机同时需要传送数据的情况，这是就会出现数据冲突，为了减少这种冲突的发生，一般采用**CSMA/CD协议**；

CSMA/CD：载波监听多点接入/碰撞检测；

> - 多点接入：说明为总线型网络
> - 载波监听：不管在想要发送数据之前，还是在发送数据之中，每个站都必须不停地检查信道
> - 在发送前检测信道是为了避免冲突，发送中检测信道是为了及时发现有其他站在发送信息，就立即中断本站的发送。这就称为碰撞检测

以下是CSMA/CD的一个例子

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231028160531085.png" alt="image-20231028160531085" style="zoom: 50%;" />

**发送的不确定性**：每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能，这一小段时间取决于另一个发送数据的站到本站的距离；由上图可知，若A在$2\tau$后还未检测到碰撞，则这次发送可定不会发生碰撞，我们将$2\tau$称作**争用期**(以太网的端到端往返时间)；发生碰撞后，CSMA/CD会终止数据的发送，推迟一段时间后再重新发送，以太网使用**截断二进制指数退避算法**来确定碰撞后的重传时间

截断二进制指数退避算法：发生碰撞后，让发生碰撞的站在停止发送数据后，不是等待信道变为空闲后就立即再发送数据，而是退避一个随机的时间。为了尽可能减小重传时发生冲突的概率，**退避算法**还有下面的**规定**：

- 基本退避时间为争用期$2\tau$，具体的争用时间是$51.2\mu s$；对于10Mbit/s以太网，在争用期可发送512比特，所以也可称争用期为512比特时
- 从离散的整数集合$[0, 1, ..., (2^k - 1)], k = Min(重传次数，10)$中随机取一个数，记为r，重传推后的时间为 r * 争用期；
- 当重传达16次时，则丢弃该帧，并向高层报告

特殊情况：当帧很短时，
