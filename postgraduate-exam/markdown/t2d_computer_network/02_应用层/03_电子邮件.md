## 2.3 电子邮件

电子邮件是一种**异步通信媒介**。主要有三个组成部分：**用户代理**、**邮件服务器**和简单邮件传输协议(Simple Mail Transfer Protocol, **SMTP**)，每个用户在邮件服务器中都有一个**邮箱**，用来管理和维护发送给该用户的报文，同时，邮件服务器中也存在**报文队列**，用来发送用户的邮件。

与HTTP类似，SMTP也由两个部分组成：运行在发送方邮件服务器的客户端和运行在接收方邮件服务器的服务器端。每台邮件服务器既运行着SMTP的客户端也运行着SMTP的服务端；当一个邮件服务器向其他邮件服务器发送邮件时，它就表现为**SMTP的客户**，当一个邮件服务器接收来自其他邮件服务器的邮件时，它就表现为**SMTP的服务器**。

### 2.3.1 SMTP



### 2.3.2 与HTTP的对比

- **HTTP**是一个**拉协议(pull protocol)**、**SMTP**是一个**推协议(push protocol)**。
  - pull protocol：用户使用HTTP协议将服务器中已有的信息拉取到本地；**TCP连接**是由**想接收文件的机器发起**的。
  - push protocol：发送邮件的服务器把邮件推到接收邮件的服务器上；**TCP连接**是由**要发送文件的机器发起**的。
- SMTP要求每个报文(包括它们的体)，采用**7比特ASCII码格式**、HTTP则不受这种限制。
- 在处理一个既包含文本又包含图形的文档时，HTTP把每个对象封装到它自己的HTTP响应报文中，而SMTP则把所有对象都放在一个报文之中。

### 2.3.3 邮件报文格式

由首部行、空行和报文体组成。首部行必须包含From: 和 To 首部行，首部和报文体均采用7比特ASCII编码，如果报文体的内容不是用ASCII码编码(如图片、视频等)，在用SMTP传送邮件之前需要将二进制多媒体数据编码为ASCII码，并且在使用SMTP传输后要求将相应的ASCII码邮件解码还原为多媒体数据。

### 2.3.4 邮件访问协议

一般来说，邮件服务器是由用户的ISP(Internet Service Provider)提供的，用户只需在本地运行用户代理程序。如下图所示的邮件传输邮件的过程，A的用户代理程序可以通过SMTP直接将邮件传送给B的邮件服务器，为什么需要分成两步呢？

> A的用户代理没有任何办法到达一个不可达的目的邮件服务器(服务器关机时)，通过将邮件存放到自己的邮件服务器中A的邮件服务器可以重复地尝试向B的邮件服务器发送该报文，如每30分钟一次，直到B的邮件服务器变得运行为止；如果几天后仍不能成功，服务器就删除该邮件，并以邮件的形式通知A

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231016164617945.png" alt="image-20231016164617945" style="zoom: 48%;" />

当A的邮件到达B的邮件服务器后，B如何取得邮件？显然，不可使用SMTP，SMTP为push protocol，无法实现pull的功能，为此一般通过引入特殊的邮件访问协议来解决这个问题，例如POP3(Post Office Protocol-Version3)、IMAP(Internet Mail Access Protocol)以及HTTP。

- **POP3**：当用户代理打开了一个到邮件服务器端口110上的TCP连接后，POP3就开始工作了。随着TCP连接的建立，POP3按照三个阶段进行工作：特许(authorization)、事务处理以及更新。
  - **特许**：用户代理发送用户名和口令(明文方式)以鉴别用户。相关命令：`user <username>`、`pass <password>`；
  - **事务处理**：用户取回报文，同时标识是否删除报文以及获取邮件的统计信息。相关命令：`list`、`retr <para>`、`dele <para>`；
  - **更新**：客户发出了quit命令后，邮件服务器删除那些被标记为删除的报文；
  - 特点：在事务处理阶段，POP3可以被配置为“下载并删除”和“下载并保留”两种方式，当配置为“下载并删除”后，邮件无法实现多端共享；POP3服务器并不在POP3会话过程中携带状态信息；
- **IMAP**：由于邮件存储在本地使用文件夹进行管理很麻烦，为此退出了线上的邮件文件夹管理，但是POP3没有给用户提供任何创建远程文件夹并为报文指派文件夹的方法，因此推出了IMAP。
  - IMAP服务器把每个报文与一个文件夹联系起来；当报文第一次到达服务器时，它与收件人的INBOX文件夹相关联；
  - IMAP为用户提供了创建文件夹、移动邮件、查询邮件的功能
  - 与POP3不同，IMAP服务器维护了IMAP会话的用户状态信息
- **HTTP**：用于Web浏览器，用户代理和用户服务器之间通过HTTP传送报文，邮件服务器与邮件服务器之间仍使用SMTP传送报文

### 2.3.5 MIME

多用途网际邮件扩充协议(Multipurpose Internet Mail Extensions，MIME)，由于SMTP的7位ASCII码的限制，因此提出了MIME协议，MIME并未改动或取代SMTP

