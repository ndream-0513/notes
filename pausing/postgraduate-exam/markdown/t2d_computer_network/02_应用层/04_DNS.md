## 2.4 DNS：因特网的目录服务

因特网上的主机可以通过**主机名**标识也可以通过**IP地址**进行标识。人们喜欢用便于记忆的主机名进行标识，而路由器喜欢定长、有着层次结构的IP地址进行标识，为此需要有一个主机名到IP地址转换的目录服务。

### 2.4.1 DNS提供的服务

DNS(Domain Name System, 域名系统)用来提供**主机名到IP地址转换的目录服务**。首先对DNS进行简要的介绍：

- DNS是一个由许多分层的DNS服务器实现的分布式数据库；

- DNS是一个使得主机能够查询分布式数据库的应用层协议；DNS协议运行在UDP之上，使用53端口；

  > DNS是应用层协议的原因：使用C/S模式运行在通信的端系统之间；在通信的端系统之间通过下面的端到端运输协议来传送DNS报文

除了目录服务外，DNS还提供了以下的一些重要服务：

- **主机别名**(host aliasing)：有着复杂主机名的主机能够拥有一个或多个别名。例如百度的主机名为`www.a.shifen.com`，而`www.baidu.com`只是它的别名(aliase)（还没找到由多个别名的例子）；
- **邮件服务器别名**(mail server aliasing)；
- **负载分配**(load distribution)：用于在冗余的服务器之间进行负载分配。

### 2.4.2 DNS工作机理概述

最简单的DNS设计就是在因特网中只使用一个DNS服务器，该服务器包含所有的映射，称作集中式设计。这种集中式设计很容易出现**单点故障**、**通信容量**、**远距离的集中式数据库**、**维护**等问题；事实上，DNS一般采用分布式进行设计，它是一个运行在因特网上的分布式数据库；

- **分布式、层次数据库**

  ```mermaid
  graph TD
  A(根DNS服务器)-->B1(com DNS服务器)
  A-->B3(org DNS服务器)
  A-->B2(edu DNS服务器)
  B1-->C1(amazon.com<br> DNS服务器)
  B1-->C2(facebook.com<br> DNS服务器)
  B2-->D1(nyu.edu<br> DNS服务器)
  B2-->D2(umass.edu<br> DNS服务器)
  B3-->E1(pbs.org<br> DNS服务器)
  ```

  这个分布式数据库主要由三种类型的DNS服务器：**根DNS服务器**、**顶级域(Top-Level Domain, TLD)DNS服务器**、**权威DNS服务器**，除了这几种主要的DNS服务器之外，还有另一类重要的DNS服务器——**本地DNS服务器(local DNS server)**，每个ISP都有一台本地DNS服务器，通常本地DNS服务器和主机相隔不超过几个路由器；

  DNS查询一般使用**递归和迭代相结合**的方式，个人主机对本地DNS服务器使用递归查询、本地DNS服务器对其他DNS服务器采用迭代查询，从理论上来讲，任何DNS查询既可以是迭代的也可以是递归的，下图是使用递归+迭代和只使用递归的例子：

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231017145803589.png" alt="image-20231017145803589" style="zoom: 50%;" />

- **DNS缓存**：在一个请求链中，当某DNS服务器接收了DNS回答时，它能将映射缓存在本地存储器中。由于主机名和IP地址的映射不是永久有效的，所以DNS服务器在一段时间后(通常设置为两天)将丢弃缓存信息。因为DNS的缓冲功能，除了少数的DNS查询以外，都不需要经过根服务器。

### 2.4.3 DNS记录和报文

所有的DNS服务器构成了DNS分布式数据库，其中存储的信息称为资源记录(Resource Record, RR)。每个回答报文中包含了一条或多条资源记录，资源记录为`(Name, Value, Type, TTL)`包含了这些字段的四元组，TTL为该记录的生存时间，它决定了资源记录应当从缓存中删除的时间；Name和Value的值取决于Type(以下例子忽略TTL)；

```
- Type = A时，Name = 主机名，Value = 该主机对应的IP地址，例如，(abc.com, 145.123.111.2, A)
- Type = NS时，Name = 某个域，Value = 知道如何获得该域中主机IP地址的权威DNS服务器的主机名，例如，(abc.com, dns1.abc.com, NS)
- Type = CNAME，Name = 别名，Value = 别名对应的规范主机名，例如，(www.baidu.com, www.a.shifen.com)
- Type = MX，Name = 别名，Value = 别名的邮件服务器的规范主机名，例如，(foo.com, mail.foo.com, MX)
```

如果一台DNS服务器为某特定主机名的权威DNS服务器，那么该DNS服务器一定会有一条用于该主机名的类型A记录，例如，用于abc.com的权威服务器，必然有记录`(abc.com, 145.123.111.2, A)`，其他DNS服务器也可能会有该记录；

如果一台DNS服务器不是用于某特定主机名的权威DNS服务器，那么该DNS必然有一条NS记录和一条A记录，NS记录对应于包含主机名的域，A记录提供NS记录的Value字段中的DNS服务器的IP地址；

- **DNS报文**

  DNS报文包括查询报文和回答报文，这两种报文的格式是相同的；

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231017143240257.png" alt="image-20231017143240257" style="zoom:50%;" />

  - 首部区域：标识符，用来标识该查询，该标识符会复制到对应的回答报文的标识符中；标志，“查询/回答”、“权威的”、“希望递归”、“递归可用”；后面四个数量字段，指出了在首部后的4类数据区域中出现的数据数量；
  - 问题区域：包含正在进行的查询信息，包括：名字字段和类型字段；
  - 回答区域：在来自DNS服务器的回答中，包含了对最初请求的名字的资源记录；
  - 权威区域：包含了其他权威服务器的记录；
  - 附加区域：包含了其他有帮助的信息；

- **在DNS数据库中插入记录**

  当你想要注册域名`abc.com`时(前提是该域名未被使用)，你需向注册登记机构提供你的基本和辅助权威DNS服务器的名字和IP地址，比如为`dns1.abc.com`和`dns2.abc.com`以及`212.212.212.1`和`212.212.212.2`，对这两个权威DNS服务器，该注册登记机构需要将一个NS记录和一个A记录输入TLD com服务器，在com服务器中插入以下数据(可静态配置也可通过报文动态配置)；

  ```
  (abc.com, dns1.abc.com, NS)
  (dns1.abc.com, 212.212.212.1, A)
  (abc.com, dns2.abc.com, NS)
  (dns2.abc.com, 212.212.212.1, A)
  ```

  你还需确保用于Web服务器的`www.abc.com`的A记录和用于邮件的`mail.abc.com`的MX记录被输入到你的权威DNS服务器中(如果你想提供网页和邮件服务的话)，完成这些步骤后，`abc.com`的网页和邮件服务可以使用了；

  如果A想要访问`www.abc.com`的网页，则需要经过以下几步：

  - A在浏览器中输入`www.abc.com`的网址回车(因为这是一个新创建的域名，所以浏览器缓存中肯定没有该域名的IP)；
  - A的主机向本地DNS服务器发送一个查询报文，该查询报文中含有待转换的主机名`www.abc.com`，本地DNS服务器将该报文转发到根DNS服务器；
  - 根DNS服务器注意到其`com`后缀，通过回答报文向本地DNS服务器返回负责`com`的TLD的IP地址列表，本地DNS服务器再次向这些TLD服务器之一转发查询报文；
  - TLD com服务器注意到`abc.com`后缀，在数据库中进行查询，发现服务器有`abc.com`的NS和A类型的资源记录，TLD com服务器将这两条资源记录通过回答报文发送给本地DNS服务器，本地DNS服务器向`212.212.212.1`转发查询报文；
  - 权威服务器接收到查询报文之后，在数据库中进行查询，发现有`www.abc.com`的A类型资源记录，权威服务器将该记录通过回答报文发送给本地DNS服务器；
  - 本地DNS服务器接收到权威服务器的回答报文之后，通过回答报文将Web服务器地址回传给主机，主机就可以通过回答报文中的地址发起TCP连接，并在该连接上发送HTTP请求了。

  

  