## 4.4 虚拟存储器

### 4.4.1 基本概念

- **虚拟存储器**：主存储器 + 联机工作的外部存储器 + 辅助硬件 + 系统软件。对程序员来说，可以看作一个单一的存储器
  - 辅助硬件（CPU中的MMU，存储管理单元，专门用来管理虚拟存储器的）
  - 系统软件（操作系统）
- 虚拟存储器中的**三种地址空间**
  - 虚拟地址空间：程序员编程中用到的地址（编译程序生成）
  - 主存储器地址空间：实际主存的物理地址（CPU地址引脚）
  - 辅存地址空间：磁盘存储器的地址
- **地址映射**：把虚拟地址空间映射到主存地址空间。我想把磁盘中的某一页装到主存中，我可以装到主存的哪一个位置上？（一般采用全相联 + LRU）
- **地址变换**：在程序运行时，把虚地址变换成主存实际地址（通过MMU实现）
- Cache和主存之间是以块为单位来交换数据的，主存和磁盘之间可以以块为单位、以页为单位，也可以以段页式为单位来交换数据，因此有**三种虚拟存储器**：段式虚拟存储器、页式虚拟存储器、段页式虚拟存储器

### 4.4.2 段式虚拟存储器

**段式存储管理方式**：将程序按逻辑意义分成段，按段进行调入、调出和管理

**地址映射方法**：每个程序段都从0地址开始编址，长度可长可短，可以在程序执行过程中动态改变程序段的长度

<img src="img\image-20230925100357454.png" alt="image-20230925100357454" style="zoom: 67%;" />

**地址变换方法**：

- 由**用户号**找到**基址寄存器**
- 从基址寄存器中读出**段表**的**起始地址**
- 把**起始地址**与多用户虚地址中的**段号**相加得到**段表地址**
- 把**段表**中给出的**起始地址**和多用户虚地址中的**段内偏移**相加就能得到**主存实地址**

<img src="img\image-20230925100638061.png" alt="image-20230925100638061" style="zoom:67%;" />

- **主要优点**：
  - 程序的**模块化**性能好
  - 便于多道程序**共享**主存中的某些段
  - 程序的**动态链接**和**调度**比较容易
  - 便于按逻辑意义实现存储器的**访问方式保护**
- **主要缺点**：
  - **地址变换**所花费的**时间长**，两次加法
  - **段映象表庞大**，地址、段长字段太长
  - **主存储器**的**利用率**往往比较**低**——存储管理复杂；段间“零头”
  - 对**辅存**（磁盘存储器）的**管理**比较**困难**

### 4.4.3 页式虚拟存储器

- **地址映射方法**：（页面大小固定）

  <img src="img\image-20230925102005628.png" alt="image-20230925102005628" style="zoom:67%;" />

- **地址变换方法**：

  - 通过**用户号**找到**基址寄存器**
  - 从**基址寄存器**中读出页表的**起始地址**
  - 把起始地址与虚地址中的虚页号相加得到**页表地址**
  - 从页表中查出**实页地址**（主存页号）直接和**页内偏移**进行拼接就能得到**主存实地址**
  - 段式中为加法，页式中为拼接

  <img src="img\image-20230925103000306.png" alt="image-20230925103000306" style="zoom:67%;" />

### 4.4.4 段页式虚拟存储器

- **段页式存储管理方式**：将程序按**逻辑意义**先分成**段**，再让各**段**和**实主存**都机械等分成相同大小的**页**面。每道程序通过一个**段表**和相应的一组**页表**来进行程序在主存空间中的定位

- **地址映射方式**：每个程序段在段表中占一行，在段表中给出页表长度和页表的起始地址，页表中给出每一页在主存储器中的实页号

  <img src="img\image-20230925103724769.png" alt="image-20230925103724769" style="zoom:67%;" />

- **地址变换方法**：

  - 先查段表，得到页表起始地址和页表长度
  - 再查页表找到要访问的主存实页号
  - 把实页号与页内偏移拼接得到主存实际地址

  <img src="img\image-20230925103948832.png" alt="image-20230925103948832" style="zoom:67%;" />

  