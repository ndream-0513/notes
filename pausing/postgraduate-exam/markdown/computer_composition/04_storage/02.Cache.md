## 4.3 高速缓冲存储器

### 4.3.1 Cache的工作原理

- 局部性原理：
  - 时间局部性：将来要使用的信息很可能是正在使用的信息，例如控制循环的变量
  - 空间局部性：将来要使用的信息很可能与正在使用的信息邻近，例如数组元素、顺序执行的指令代码
- 工作过程：

![image-20230922191748635](img\image-20230922191748635.png)

- CPU同时向Cache和主存储器传递主存地址

- Cache接收到地址之后根据主存地址中的块号在Cache目录表中进行查找
  - 在Cache目录表中，命中，结束访问主存的命令，将内存地址转换为Cache的内部地址，按照这个内部地址来访问Cache，将数据读取出来传递给CPU
  - 未命中，继续访问主存，在主存中找到数据，将数据送给CPU，同时将包括该数据的块装入Cache中
    - Cache未满，将该块直接装入Cache中，在Cache目录表中进行记录
    - Cache已满，根据Cache替换策略替换掉Cache中的某个块再将新的块装入Cache中，更新Cache目录表
      - 如果待替换的块没有被CPU修改，直接替换即可
      - 如果代替换的块被CPU修改过（Cache中的数据是新的，主存中的数据已经过时了），需要将被修改的块写回到主存中，才能替换

### 4.3.2 主存与Cache的地址映射

- 地址映象：把主存中的数据按照某种规则装入到Cache中，并建立主存地址与Cache地址之间的关系

- 地址变换：当主存数据装入到Cache之后，在程序运行过程中，把主存地址转换为Cache地址

- 主存和Cache之间是以块为单位进行调度的

- Cache的三种映射规则：全相联、直接映射、组相联

  - **全相联**：主存的任意一块可以映射到Cache中的任意一块

    - 特点：
    - 块冲突概率低、Cache利用率高
    - 相联目录表的容量过大会导致成本高、查表速度慢

    ![image-20230924150431565](img\image-20230924150431565.png)

  - **直接映射**：主存中的块只能映射到Cache中特定的块中

    - 整个Cache地址与主存地址的低位部分完全相同
    - 优点：
      - 硬件简单，不需要相联存储器
      - 访问速度快（无需地址变换）
    - 缺点：
      - Cache块冲突概率高
      - Cache空间利用率很低

    ![image-20230924150935056](img\image-20230924150935056.png)

  - **组相联**：将主存空间按照Cache大小等分成**区**，再将Cache和主存空间中的每一区都等分成大小相同的**组**，再将主存和Cache都机械等分成相同大小的**块**，让 主存各区中的某组中的任何一块均可直接映射到Cache中对应组的任何一块上。从主存的组到Cache的组之间采用直接映射 方式，在两个对应的组内采用全相联映射方式——**组间直接、组内全相联**

    - 目的：减小相联目录表的容量，降低成本，提高地址变换速度
    - 优点
      - 块的冲突概率比较低
      - 块的利用率大幅度提高
      - 块的失效率明显降低
    - 缺点：实现难度和造价比直接映射方式高

    ![image-20230924151926815](img\image-20230924151926815.png)

  - 根据Cache大小可以确定主存地址中区号占多少位、组号+块号+块内地址占多少位，由块的大小可以确定块内地址占多少位，由一个组中块的多少可以确定块号有多少位，由此可得到组号占多少位

    ![image-20230924164932230](img\image-20230924164932230.png)

  - 如何计算Cache目录表的容量？目录表的行号（组号+Cache组内块号）不需要存储，目录表容量 = （区号位数 + 其它信息）* 行数

  - Cache中需要存储的其它信息

    - 有效位（一般都有）
    - 修改位（采用写回法时才有）
    - 计数 器（替换策略）

### 4.3.3 替换算法

- 直接映射不需要替换算法
- **随机算法**（RAND，Random Algorithm）
- **先进先出算法**（FIFO，First In First Out）
  - 利用了历史信息
  - 没有反映局部性——最先调入的，可能也是要使用的
- **最不经常使用算法**（LFU，Least Frequently Used）：计数器多，实现困难
- **近期最少使用算法**（最久未用）替换算法（LRU，Least Recently Used）：
  - 替换近期最久未用的块
- **最佳替换算法**（OPT，Optional Replacement）

### 4.3.4 主存与Cache内容的一致性问题

- **写回法**

  - Cache命中→只修改Cache→Cache中该块需替换时才写回主存（在替换之前的这段时间中，存在主存和Cache内容不一致的问题）
  - Cache不命中→该块从主存拷贝至Cache，在Cache中进行修改（**写分配法**）

- **全写法**（写直达法）

  - Cache命中→写Cache，同时写主存（一致性好）
  - Cache不命中→直接写主存，不调入Cache（**非写分配法**）
  - 缺点：每次需要修改Cache和主存，速度较慢

  <img src="img\image-20230924182630328.png" alt="image-20230924182630328" style="zoom:67%;" />

### 4.3.5 Cache性能分析

- Cache-主存系统的**平均访问周期（平均访问时间）$T_A$**

  - CPU可以直接访问主存：$T_A = H*T_C + (1-H)*T_M$
  - CPU不可以直接访问主存：$T_A = H*T_C + (1-H)*(T_B + T_C)$

  - $T_C$：Cache的访问周期；$T_M$：主存的访问周期；$T_B$：数据块装入Cache的时间；$H$：Cache的命中率

- Cache-主存系统的**加速比$S_P$：**$S_P = T_M/T_A$

- 两级Cache的总失效率 = $(失效率)_{第一级} *(失效率)_{第二级}$

### 4.3.6 AMD Opteron处理器的数据Cache

408中是使用这种分析方式

Cache的参数：容量：64KB；块大小：64B；映射方式：2路组相联；替换策略：LRU；写策略：写回法；Cache一致性策略：改进的MESI

![image-20230925120555771](img\image-20230925120555771.png)

- **主存2KB、Cache 512B、2路组相联、每块64B**

  2路组相联：将Cache均分为两路，一路4块；主存按照Cache每一路的容量进行分区，2KB，32块，32/4 = 8，所以主存需分为8个分区；区内块数=Cache组数

  - **地址映射（数据装入）过程**：

    <img src="img\image-20230926145310296.png" alt="image-20230926145310296" style="zoom:67%;" />

  - **地址变换过程**（只考虑访问Cache）：

    -  利用主存地址的索引字段访问2路目录表的第2行，为了加快读取速度，会同时利用索引+块内地址去访问Cache中存储的数据，然后将数据作为2:1mux（2选一多路数据选择器）的输入

    - 将目录表的内容读取出来，作为数字比较器的一路输入，另一路输入为主存地址的高三位（标志位），然后在根据有效位来决定是否进行比较，然后数据比较器的输出就会控制2:1mux的输出

    <img src="img\image-20230926150342073.png" alt="image-20230926150342073" style="zoom:67%;" />

- **主存2KB、Cache 512B、4路组相联、每块64B**

  4路组相联：将Cache均分为4路，一路2块；主存按照Cache每一路的容量进行分区，2KB，32块，32/2 = 16，所以主存需分为16个分区；区内块数=Cache组数

  - **地址映射（数据装入）过程**：

    <img src="img\image-20230926151625046.png" alt="image-20230926151625046" style="zoom:67%;" />

    

  - **地址变换过程**：

    - 利用主存地址的索引字段访问4路目录表的第0行，为了加快读取速度，会同时利用索引+块内地址去访问Cache中存储的数据，然后将数据作为4:1mux（4选一数据选择器）的输入

    - 将目录表的内容读取出来，作为数字比较器的一路输入，另一路输入为主存地址的高四位（标志位），然后在根据有效位来决定是否进行比较，然后数据比较器的输出就会控制4:1mux的输出

    <img src="img\image-20230926152034706.png" alt="image-20230926152034706" style="zoom:67%;" />
