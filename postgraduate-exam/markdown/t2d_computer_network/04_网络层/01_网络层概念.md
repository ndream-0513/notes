## 4.1 网络层概念

### 4.1.1 网络层提供的两种服务

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231029152029414.png" alt="image-20231029152029414" style="zoom:60%;" />

### 4.1.2 网络层的两个层面

在路由器之间传送的信息有以下两大类：**转发源主机和目的主机之间所传送的数据**、**传送路由信息**；因此也可将网络层分为**数据层面**和**控制层面**，数据层用来传送数据、控制层用来形成路由表；

> 不同网络中的不同主机之间的通信，需要经过若干个路由器转发分组完成；分组到达路由器后，查找路由器的转发表，转发表中指明的接口转发到下一个路由器(或网络)；转发表是从路由表中得到的，而路由表又是由互联网中许多路由器，按照共同选定的路由选择协议，通过多次交换路由信息得到的，因此，

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031084254407.png" alt="image-20231031084254407" style="zoom:50%;" />

在数据层面中，一般用硬件实现数据的转发，时间在纳秒($10^{-9}$)级别；在控制层面中，只能用路由选择软件得到路由表，时间在秒级别，相比数据层面要慢很多，因此提出了**SDN**(Software Defined Network, **软件定义网络**)；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031084347747.png" alt="image-20231031084347747" style="zoom:50%;" />

在SDN中，没有路由选择软件，路由器之间也无需交换路由信息，在网络的控制层面有一个逻辑上集中的**远程控制器**(物理上可以不集中)；远程控制器掌握各主机和整个网络的状态，能为每一个分组计算出最佳路由，然后在每一个路由器中生成器正确的转发表；路由器只需收到分组、查找转发表、转发分组即可； 

## 4.2 网际协议IP

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231029153053709.png" alt="image-20231029153053709" style="zoom:67%;" />

### 4.2.1 虚拟互连网络

当主机之间的中间设备为转发器或网桥时，这仅仅是把网络扩大了，一般不称为网络互连；由于网关比较复杂，使用的较少，在讨论网络互联时，一般都是指用路由器的网络互连和路由选择；因为参加互连的网络都是使用的网际协议IP，我们也将这种虚拟互连的网络称为**IP网**；下图是从主机H1向H2传送数据的例子，需要经过路由器的交付为**间接交付**、不需要经过路由器的为**直接交付**；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031084540449.png" alt="image-20231031084540449" style="zoom:50%;" />

### 4.2.2 IP地址

#### 1. IP地址及其表示法

IP地址就是给互联网上的每一台主机(或路由器)的每一个接口，分配一个在全世界范围内唯一的32位标识符；在机器中直接使用32位连续的二进制进行标识，为了它的可读性，我们一般使用**点分十进制记法**来标识IP地址；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231029154742560.png" alt="image-20231029154742560" style="zoom:67%;" />

IP地址不仅标识了主机(路由器)，而且标识了此接口所连接的网络，`IP地址 ::= {<n位网络号>, <32-n位主机号>}`；

> 特殊情况：当一台主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，其网络前缀必须是不同的，这种主机称为**多归属主机**；例如，一个路由器至少连接两个网络，因此一个路由器至少有两个IP地址，但未了节省IP地址资源，对于点对点链路构成的特殊“网络”，一般不分配IP地址，通常把这样的特殊网络叫做**无编号网络**或**匿名网络**；

#### 2. 分类的IP地址

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231029155515765.png" alt="image-20231029155515765" style="zoom:67%;" />

由于分类的IP地址的网络号的位数是固定的，无法灵活的进行划分，因此造成了很多IP地址的浪费，在IP地址不足的情况下，现已不使用这种IP地址划分；下表是一些一般不指派的特殊IP地址的总结：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031085117668.png" alt="image-20231031085117668" style="zoom:50%;" />

#### 3. 无分类编址CIDR

`IP地址 ::= {<n位网络前缀>,<32-n位主机号>}`，与分类的IP地址的形式相同，只不过网络前缀不是固定的，可以选取0~32之间的任意值；CIDR采用“**斜线记法**”，斜线后面是网络前缀所占的位数，注意区分IP地址和CIDR地址块：

```
128.14.32.7是IP地址，但未指明网络前缀长度，不知道网络地址
128.14.32.7/20是IP地址，网络地址为128.14.32.0/20
128.14.32.0/20是包含多个IP地址的地址块或网络前缀
```

**网络地址的计算**：CIDR通过斜线记法可以让我们知道网络前缀的值，但是计算机看不懂斜线记法，计算机通过把二进制的IP地址和地址掩码(子网掩码)进行按位AND运算来得到网络地址；

**CIDR中的三个特殊地址块**：

- 网络前缀为32位的CIDR块，一般用于主机路由，本质就是一个IP地址；
- 网络前缀为31位的CIDR块，一般用于点对点链路，例如路由器和路由器之间；
- 0.0.0.0/0，默认路由；

### 4.2.3 IP地址与MAC地址

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231029162950951.png" alt="image-20231029162950951" style="zoom:67%;" />

MAC地址是数据链路层使用的地址，是一种物理地址；IP地址是网络层及以上各层使用的地址，是一种逻辑地址；数据链路层收到网络层传递下来的IP数据报后，将IP数据报作为数据部分，然后加上首部和尾部组成MAC帧，主机通过MAC帧首部的目的MAC将帧进行交付，那么目的MAC是如何得到的？一般通过ARP将目的IP解析为目的MAC(但是目的IP是怎么得到的呢?)

### 4.2.4 地址解析协议ARP

除了地址解析协议ARP外，还有RARP(逆地址解析协议，MAC转IP)，只是现已不适用，已将其功能整合到了DHCP中；ARP解决地址解析的方法是通过在主机中增加一个ARP高速缓存，在这个高速缓存中存放从IP地址到MAC地址的映射表，并且这个表还经常动态更新；以下是使用ARP的例子：

- 主机A向**同一局域网**上的主机B发送IP数据报(ARP高速缓存中没有B的IP到MAC的映射，A刚加电ARP缓存为空或B刚入网)：

  - 首先在ARP高速缓存中**查表**。如有，就把得到的MAC地址写入MAC帧，然后通过局域网把该MAC帧发往此MAC地址；

  - 查表发现没有，ARP进程在本局域网上**广播**发送一个**ARP请求分组**。ARP请求分组的主要内容为“告诉接收方本机的IP和MAC，我想要知道IP为xxxx的MAC”，ARP请求分组一般分装在MAC中进行发送；

  - 本局域网上的所有主机中运行的ARP进程都接收该ARP请求分组；

  - 主机B发现请求中要查询的IP与本机IP一致，就接受这个ARP请求分组，向A发送**ARP响应分组**(同时在自己的ARP缓存中添加到主机A的映射)，并在响应分组中写入自己的MAC地址；因为ARP请求与本机IP不一致，其余主机都不理睬这个ARP请求；

    > 注：虽然ARP请求分组是广播发送的，但ARP响应分组是普通的单播；

  - 主机A收到主机B的响应分组后，就在其ARP高速缓存中写入主机B的IP到MAC的映射；

- **使用ARP的四种典型情况**：

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231030144519168.png" alt="image-20231030144519168" style="zoom:67%;" />

  - H1→H2：H1可以直接通过广播ARP请求分组得到H2的MAC地址；
  - H1→H3/H4：H1通过广播ARP请求分组找到R1的MAC，然后将分组转发给R1，剩下的工作由R1完成；
  - R1→H3：R1通过在N2(网2)上广播ARP请求分组得到H3的MAC地址；
  - R1→H4：R1通过广播ARP请求分组找到R2的MAC，然后将分组转发给R2，剩下的工作由R2完成；

> 既然网络链路上传送的帧最终是按照MAC地址找到目的主机的，那么为什么我们还要使用两种地址(IP和MAC)，而不直接使用MAC地址进行通信？

### 4.2.5 IP数据报的格式

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231030150107234.png" alt="image-20231030150107234" style="zoom:67%;" />

- **版本**：4bit，4为IPV4，6为IPV6；**首部长度**：因为IP的首部是可变的所以需要首部长度字段，4bit，单位4B；

  > 因为IP首部最少为20B，所以首部长度最小为5，最大为15(因为只有4bit)，所以IP首部最大可达60B；
  >
  > 当IP首部的长度不是4B的整数倍时，需要使用填充字段填充到4B的整数倍

- **区分服务**：8bit，服务类型，很少使用；**总长度**：16bit，单位1B，首部+数据，最大值65535B；

- **标识**：16bit，不等于TCP中的序号；**标志**：3bit，未使用+DF+MF，DF = 0允许分片，MF = 1还有分片；**片偏移**：13bit，单位8B

  > 链路层中一般都规定了数据部分的最大长度，即MTU，例如，以太网帧的MTU=1500B，当IP数据报的长度超过1500时就需要进行分片处理(一般是在本地主机/下一条路由中分片，在目的主机中复原)，分片后的IP数据报具有相同的标识，**目的主机通过标识和片偏移来对分片的IP数据报进行重组**；片偏移指出了某片在原分组中的相对位置，片偏移是以8B为偏移单位的，因此，除最后一个字节外，其他的每个分片的长度一定是8B(64bit)的整数倍

- **生存时间**：8bit，TTL，以条数为单位；**TTL指出了分组转发过程经过的路由器的数量**，只有路由器接收分组时TTL才会减1，目的主机接收分组TTL并不会减少；

- **协议**：指出IP数据报携带的数据使用何种协议，便于向上层交付，常用协议值：

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231030152255268.png" alt="image-20231030152255268" style="zoom:67%;" />

- **首部检验和**：16bit，只检验IP数据报的首部，不检验数据部分(这也是ICMP中为什么有检验和的原因)；

- **源地址、目的地址**；**可变部分**：提供排错、测量和安全等功能；



## 4.3 IP转发分组的过程

分组在互联网上的传送和转发是基于分组中的目的IP地址的，因此这种转发方式称为**基于终点的转发**；**分组转发过程**是先查找目的IP的目的网络(网络前缀)，在找到了目的网络之后，再把分组在这个网络上直接交付给目的主机；以下是分组转发的一个例子：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031085423730.png" alt="image-20231031085423730" style="zoom:50%;" />

- H1转发给H2的分组的目的IP为128.1.2.132，当H1的分组到达R1后，就查找R1中的转发表，然后转发给接口1；查找转发表的过程就是一个**寻找前缀匹配的过程**：主机H1把分组的目的IP和本网络的子网掩码进行按位AND运算，得出运算结果，如果运算结果与本网络的前缀相等，则表明H1和H2在同一个网络上，否则，就需要把分组转发给路由器R1，由R1完成后续的任务；
- H1所在的网络为128.1.2.196/26，目的IP为128.1.2.132，目的IP与子网掩码按位AND运算的结果为128.1.2.128/26，逐行查找R1中的转发表，发现与第二行匹配，所以将分组转发给接口1；

### 4.3.1 最长前缀匹配

下图是最长前缀匹配的一个例子；公司B包含三个子网，但这些网络前缀并没有出现在R1中，这是因为公司B采用了**路由聚合**；目的IP为128.1.24.1的分组到达R1后，将目的IP与每行的子网掩码进行按位AND运算，发现与前两行都匹配，此时，一般选择前缀最长的一个作为匹配的前缀，这个原则称为**最长前缀匹配原则**，根据这个原则，有的转发表中会按照前缀从长到短依次对表中的项进行排序；

> 路由聚合：一个大的CIDR地址块中往往包含很多小地址块，所以在路由器的转发表中可以利用较大的一个CIDR地址块来代替许多较小的地址块

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031091135628.png" alt="image-20231031091135628" style="zoom:50%;" />

在转发表中还有两种特殊的路由，**主机路由**和**默认路由**。主机路由又称为特定主机路由，这是对特定目的主机的IP地址专门指明的一个路由，例如**a.b.c.d/32**，就是a.b.c.d的主机路由；默认路由是指无论分组的最终目的网络在哪里，都由指定的路由器R来处理，默认路由一般为**0.0.0.0/0**；

**分组转发过程总结**：

1. 首先从收到的分组首部提取目的IP；
2. 若查找到有目的IP的特定主机路由，就按照这条路由的下一跳转发分组；否则从转发表中下一行开始检查，执行3；
3. 把这一行的子网掩码与目的IP进行按位AND运算；若运算结果与本行的前缀匹配，则查找结束，将分组转发至下一跳；否则，若转发表还有下一行，则对下一行进行检查，重新执行3；否则执行4；
4. 若转发表中有一个默认路由，转发至默认路由的下一跳；

### 4.3.2 使用二叉线索查找转发表

当路由器线路的速率为10Gbit/s、分组的平均长度为2000bit时，那么路由器就应当平均每秒钟能够处理500万个分组，处理一个分组的时间只有1ns，可见查找每一个路由所需的时间是非常短的，一般使用二叉线索来实现转发表的快速查找；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031093139257.png" alt="image-20231031093139257" style="zoom:50%;" />

- 根据转发表中的IP地址，找到它们对应的唯一前缀(每个二叉树的叶节点包含所对应的网络前缀和子网掩码)；
- 当搜索到一个叶节点时，将目的IP与叶节点的子网掩码进行按位AND运算，看得到的结果是否与对应的网络前缀匹配；
- 若匹配，就按下一跳的接口转发该分组，否则，就丢弃该分组；

为了提高二叉线索的查找速度，还可使用**压缩技术**，例如上图中的最后两个地址的前四位都是1011，因此只要一个地址的前四位为1011，就可以跳过前面四位，而从第五位开始比较；

## 4.4 网际控制协议ICMP

ICMP允许主机或路由器报告差错情况以及提供有关异常情况的报告；虽然ICMP作为IP报文的数据部分装在IP数据报中，但ICMP不是高层协议，它仍是网络层协议；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231030154433944.png" alt="image-20231030154433944" style="zoom:67%;" />

- **类型**：指明了ICMP报文类型；**代码**：进一步区分某种类型中的几种不同情况；**检验和**：用来检验整个ICMP报文(因为IP只检验首部)
- **ICMP的数据部分**：需要进行差错报告的IP数据报的首部和数据部分的前8个字节；

### 4.4.1 ICMP报文的种类

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231030154607086.png" alt="image-20231030154607086" style="zoom:67%;" />

- **时间超过**：路由器收到TTL=0的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文；

- **改变路由(重定向)**：互联网中，只有路由器和路由器之间才定期交换路由信息，而主机和路由器之间并不和路由器定期交换路由信息(主机太多了)，那么主机是如何知道路由信息的呢？

  > 在主机刚开始工作时，一般都会在转发表中设置一个默认路由，不管数据发往何处，都先把数据报发给这个路由器；
  >
  > 如果默认路由发现主机发往某个目的IP的最佳路由应当由另一个路由器进行转发，那么默认路由就用改变路由报文将这个情况通知主机，主机收到报文后，就在转发表中增加一个项目：到xxxx的数据应发给R(而不是默认路由)

- **回送请求或回送回答**：收到此报文的主机必须给源主机或路由器发送**ICMP回送回答报文**；这种询问报文一般用来测试目的站是否可达以及了解目的站的有关状态；
- **时间戳请求或回答**：可用于计算当前网络时延；

### 4.4.2 ICMP的应用举例(ping、traceroute)

**PING**：通过使用ICMP回送请求与回送回答报文测试两台主机之间的连通性；它是应用层直接使用网络层ICMP的一个例子，**没有通过TCP或UDP**；

```
acs@ed679d88415b:~$ ping -c 4 www.bilibili.com
PING a.w.bilicdn1.com (124.239.244.15) 56(84) bytes of data.
64 bytes from 124.239.244.15 (124.239.244.15): icmp_seq=1 ttl=50 time=10.3 ms
64 bytes from 124.239.244.15 (124.239.244.15): icmp_seq=2 ttl=50 time=10.3 ms
64 bytes from 124.239.244.15 (124.239.244.15): icmp_seq=3 ttl=50 time=10.2 ms
64 bytes from 124.239.244.15 (124.239.244.15): icmp_seq=4 ttl=50 time=10.3 ms

--- a.w.bilicdn1.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3004ms
rtt min/avg/max/mdev = 10.247/10.266/10.294/0.017 ms
```

traceroute：UNIX中为traceroute命令、win中为tracert命令；traceroute从源主机像目的主机发送一连串的IP数据报，数据报中封装的是**无法交付的UDP数据报**(错误端口)，用来跟踪一个分组从源点到终点的路径；

初始时，TTL设置为1，R1会收到超时的数据报，之后向源主机发送一个**ICMP时间超过报文**；再将TTL设置为2，R2收到超时的数据报，也向源主机发送一个**ICMP时间超过报文**；就这样一直进行下去，当最后一个数据报刚刚到达目的主机时，数据报的TTL = 1，主机不转发数据报，也不将TTL减1，由于数据报中封装的是无法交付的UDP数据报，因此目的主机要向源主机发送**ICMP终点不可达差错报告报文**

```
$ tracert www.bilibili.com

通过最多 30 个跃点跟踪
到 a.w.bilicdn1.com [2408:873c:6810:3::13] 的路由:

  1     3 ms    14 ms     2 ms  2408:8453:2f3b:5ae::83
  2     *        *        *     请求超时。
  3    30 ms    25 ms    35 ms  fe10:1:1:7::81:0
  4    32 ms    39 ms    37 ms  2408:8142:4000:1::a702
  5    36 ms    28 ms    32 ms  2408:8001:200e:1::402
  6    35 ms    34 ms    28 ms  2408:8001:200e:1::100
  7    34 ms     *        *     2408:8001:20f0:1::218
  8    50 ms     *       50 ms  2408:8000:2:93b::
  9    58 ms    52 ms    47 ms  2408:8000:a009:2::11
 10    60 ms    49 ms    49 ms  2408:873c:6001:1::47
 11    71 ms    47 ms    47 ms  fec0:1::84
 12   509 ms    60 ms    47 ms  fec0:1::168
 13   218 ms    47 ms    44 ms  fec0:1::175
 14    83 ms   204 ms   318 ms  fec0:3::35b
 15    42 ms    67 ms    46 ms  2408:873c:6810:3::13

跟踪完成。
```

注意：对于每一个TTL会测试三次，因此每一行中有三个时间；从原则上来讲，IP数据报经过的路由器越多，所花费的时间也会越长，但从上面的结果来看，也不一定，到达第14跳的时间有时会比达到第12跳的时间要快，这是因为互联网的拥塞程度随时都在变化；

## 4.5 IPv6

可以从根本上解决IP地址耗尽的问题

### 4.5.1 IPv6的基本首部

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031103228640.png" alt="image-20231031103228640" style="zoom:67%;" />

IPv6**相对于IPv4的主要变化**：更大的地址空间；首部长度固定；协议可继续扩充；支持即插即用，无需DHCP；支持资源的预分配；**IPv6的首部为8字节对齐，而IPv4的首部为4字节对齐**；

- **通信量类**：8bit，用于区分不同的IPv6数据报的类别或优先级，与IPv4的区分服务字段类似；

- **流标号**：用于实现资源的预分配；所有属于同一个流的数据报都具有同样的流标号，同一个流所经过的路径上的路由器都保证指明的服务质量；

  > 流标号对实时音频/视频数据的传送特别有用；对于传统的电子邮件或非实时数据，流标号则没有用处，将其置零即可；

- **有效载荷长度**：16bit，指明了IPv6数据报除基本首部外的字节数(所有的扩展首部也都算在有效载荷长度中)

- **下一首部**：8bit，相当于协议或可选字段；当IPv6数据报中没有扩展首部时，下一首部字段的作用同IPv4中的协议字段，指明了上层所用协议；当出现扩展首部时，下一首部字段的值用来标识第一个扩展首部的类型；

### 4.5.2 IPv6的地址

IPv6的**目的地址**有以下三种类型：**单播地址**、**多播地址**和**任播地址**；IPv6地址使用**冒号十六进制记法**，记住以下几条规则即可：

- 只能省略**前导零**；可以使用**0压缩**，但只能使用**一次**；`FF05::B3:0:0`
- 冒号十六进制记法可以结合使用**点分十进制记法**；`::128.10.2.1`
- 仍可使用**CIDR斜线记法**，但是取消了子网掩码；`FF05::B3:0:0/80`

> 任播地址的终点是一组计算机，但数据报只交付其中一个，通常是按照路由算法得出的最近的一个；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031110743820.png" alt="image-20231031110743820" style="zoom:67%;" />



### 4.5.3 IPv4向IPv6的过渡

有两种常用的方法：双协议栈和隧道技术；

#### 1. 双协议栈

双协议栈是指在完全过渡到IPv6之前，使一部分主机(或路由器)，同时装有IPv4和IPv6这两种协议栈；双协议栈可以通过DNS查询目的IP是使用的IPv4还是IPv6；双协议栈要装两套协议，付出的代价太大，所以一般采用隧道技术；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031111917769.png" alt="image-20231031111917769" style="zoom:67%;" />

#### 2. 隧道技术

工作原理：当IPv6进入IPv4网络时，把IPv6数据报封装为IPv4数据报，当IPv4数据报离开IPv4网络中的隧道时，再把数据部分(即原来的IPv6数据报)交给主机的IPv6协议栈；

> 需要将IPv4首部的协议字段的值设置为41，才能使双协议栈的主机知道IPv4数据报里面封装的数据是一个IPv6数据报；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031112144463.png" alt="image-20231031112144463" style="zoom:67%;" />

### 4.5.4 ICMPv6

在IPv6中ARP和IGMP都整合到了ICMPv6中，ICMPv6报文主要可以分为以下几种：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231030164555955.png" alt="image-20231030164555955" style="zoom:50%;" />



## 4.6 互联网的路由选择协议

按照路由算法能否随网络通信量或拓扑自适应地进行调整来划分，可分为**静态路由选择协议**(非自适应路由选择协议)和**动态路由选择协议**(自适应路由选择协议)；RIP、OSPF、BGP都属于动态路由选择协议；

互联网的规模非常大，一般把互联网划分为多个**自治系统**(autonomous system, AS)，自治系统间的路由选择称为**域间路由选择**，自治系统内的路由选择称为**域内路由选择**；按照互连网的层次进行划分，路由选择协议可分为**内部网关协议(IGP)**和**外部网关协议(EGP)**，RIP、OSPF属于IGP，BGP属于EGP；

> 注意：也有名为EGP的EGP，只不过现已很少使用，注意根据题目进行区分

### 4.6.1 内部网关协议RIP

使用RIP协议的路由器的**路由表中最主要的信息**是“到某个网络的距离”以及“应经过的下一跳地址”；**路由表的更新原则**是找出到每个网络的最短距离，这种更新算法称为**距离向量算法**；距离一般定义为“跳数”，距离=16时为不可达，所以一般用于小型网络；以下是**RIP协议的一些特点**：

- 仅和相邻路由交换信息；

- 路由器交换的信息是当前路由器所知道的全部信息，即自己当前的路由表；

- 按固定时间间隔交换路由信息；

  > 当网络拓扑发生变化时，路由器会及时的向相邻路由器通告拓扑变化后的路由信息；网络中的主机虽然也运行RIP协议，但只被动的接收路由器发来的路由信息
  >
  > RIP协议让一个自治系统中的所有路由器都和自己的相邻路由器定期交换路由信息，并不断更新路由表，使得从每一个路由器到每一个目的网络的路由都是最短的(即条数最少)
  >
  > > 注意：虽然所有路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表也各不相同；

现今最常用的RIP协议为RIP2，支持CIDR和多播，提供简单的鉴别过程；RIP报文作为运输层用户数据报UDP的数据部分进行传送(使用UDP的520端口)，它属于运输层协议；

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031144847191.png" alt="image-20231031144847191" style="zoom:67%;" />

- RIP首部：**自治号ASN**(RIP可能收到其他自治系统的信息) + **目的网络地址**(包括子网掩码) + **下一跳路由器地址** + **到此网络的距离**；
- 一个RIP报文最多可包括**25条路由**，如果超过则必须再用一个RIP报文进行发送；

#### 1. 距离向量算法

对每一个相邻路由器发送过来的RIP报文，执行以下步骤：

- 修改收到的RIP报文；对来自路由器X的RIP报文，先把“下一跳”字段中的地址字段都改为X，再把所有的“距离”字段的值加1；
- 若原来的表中没有目的网路Net，而收到的RIP中有，则把该表项添加到路由表中；否则，若下一跳路由器地址是X，则用收到的表项替换原路由表中的项目；若下一跳路由不是X且收到的表项中的距离小于路由表的距离，则进行更新；否则什么也不做；
- 若3分钟内还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达，即把距离设置为16；

下面是一个具体的例子，路由器R6收到路由器R4发来的RIP报文之后的更新操作：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031143734098.png" alt="image-20231031143734098" style="zoom:67%;" />

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031143806968.png" alt="image-20231031143806968" style="zoom:67%;" />

#### 2. 坏消息传播得慢

RIP协议的特点：好消息传播得快，坏消息传播得很慢；下面是一个例子，解释了为什么：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031150137298.png" alt="image-20231031150137298" style="zoom:67%;" />

### 4.6.2 内部网关协议OSPF

OSPF，开放最短路径优先，使用了Dijkstra的**最短路算法SPF**，使用**链路状态协议**，而不是RIP的距离向量协议；以下是**OSPF的特点**：

- 使用洪泛法向本自治系统中所有路由器发送信息；而不是向相邻路由器发送信息；

  > 洪泛法：路由器通过所有输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再将此信息发往其连接的所有路由器(不再发给刚刚发来信息的路由器)，这样整个AS中的所有路由器都可以收到这个信息的副本；

- 发送的信息就是与本路由器相邻的所有路由器的链路状态；

  > 链路状态：本路由器与哪些路由器相邻以及链路的“度量”

- 当链路状态发生变化或每隔一段时间，路由器向所有路由器用洪泛法发送链路状态信息；

由于各路由器之间频繁的交换链路状态信息，最终每个路由器都能得到**整个AS的网络拓扑结构图**(RIP中的路由器不知道)；为了使OSPF适用于规模很大的网络，OSPF可将一个AS再划分为若干个区域，以下是一个划分的例子：

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031152248650.png" alt="image-20231031152248650" style="zoom:67%;" />

- **主干区域**0.0.0.0，可以通过主干区域的**AS边界路由器**和其他自治系统通信，主干中的路由器称为**主干路由器**；
- 其他区域，通过**区域边界路由器**和其他区域取得联系，每个区域至少有一个区域边界路由器，一个主干路由器可以同时是一个区域边界路由器；

其他特点：

- OSPF允许管理员给每条路由指派不同的度量(代价)；可以为费用、距离、时延等

- OSPF支持负载均衡；如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径；(RIP中只有一条最佳的)

- 由于网络中链路状态可能经常发生变换，因此OSPF让每一个链路状态都带上一个32为的序号，序号越大状态就越新；

- OSPF分组是作为IP数据报的数据部分来传送的，不使用UDP，而是直接使用IP数据报(协议字段值为89)，所以**OSPF为网络层协议**，OSPF构成的数据报很短；

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031153641775.png" alt="image-20231031153641775" style="zoom:67%;" />

#### 1. OSPF的五种分组类型

- 类型一：问候(Hello)分组，用于发现和维持邻站的可达性；

  > OSPF规定每十秒就要交换一次问候分组；若有40秒没有收到某个相邻路由器发来的问候分组，则认为该相邻路由是不可达的，应立即修改链路状态数据库，并重新计算路由表；

- 类型二：数据库描述分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息；

- 类型三：链路状态请求分组，向对方请求发送某些链路状态项目的详细信息；

  > OSPF使用数据库描述分组和链路状态请求分组建立同步的链路数据库；

- 类型四：链路状态更新分组，用洪泛法对全网更新链路状态；

- 类型五：链路状态确认分组，对链路更新分组的确认；

  > 当链路状态发生变化或每隔一段时间，路由器发送链路状态更新分组，OSPF使用的是可靠的洪泛法，当路由器收到链路状态更新分组后，需要向发出链路状态更新分组的路由器发送链路状态确认分组；下图中的黑色箭头为链路状态更新分组；白色箭头为链路状态确认分组；

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231031154859070.png" alt="image-20231031154859070" style="zoom:50%;" />

### 4.6.3 外部网关协议BGP

对于规模巨大、错综复杂的互联网，BGP并不是计算出一条最佳路由，而是力求选择出一条比较好的路由；BGP采用**路径向量路由选择协议**；

#### 1. BGP路由

在一个AS中有两种不同功能的路由器，即**边界路由器**和**内部路由器**；一个AS中至少要有一个边界路由器和相邻的AS的边界路由器相连；

当两个边界路由器进行通信时，必须先建立TCP连接(端口号为179)，这种TCP连接又称为半永久连接，例如图中的R1向R2发送BGP路由`X, AS1, R1`之前就需先建立TCP连接；边界路由器获得BGP路由之后，需要将BGP路由转发给内部路由器；

当边界路由器和内部路由器进行通信时，也需要建立和上面相同的TCP连接，BGP规定一个AS内部的iBGP必须是全连通的，所以边界路由器会和所有的内部路由器建立逻辑连接并向所有的内部路由器转发BGP路由；

















