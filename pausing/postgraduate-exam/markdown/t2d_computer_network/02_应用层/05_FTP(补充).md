## 2.5 FTP(文件传送协议)

文章来源：[网络基础知识笔记05：FTP基本原理与配置(上) - 若水一瓢 - 博客园 (cnblogs.com)](https://www.cnblogs.com/zylSec/p/14702823.html)

FTP 采用C/S的结构。提供了一种在服务器和客户机之间上传和下载文件的有效方式；FTP提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限；

一个FTP服务器进程可同时为多个客户进程提供服务。FTP的服务器进程由两大部分组成：一个主进程，负责接收新的请求；另外由若干个从属进程，负责处理单个请求；

### 2.5.2 FTP传输文件的过程

<img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231017161535992.png" alt="image-20231017161535992" style="zoom:67%;" />

使用FTP进行文件传输时，会使用两个TCP连接：

- 第一个连接是FTP客户端和FTP服务器间的**控制连接**。FTP服务器开启TCP 21号端口，等待FTP客户端发送连接请求；FTP客户端随机开启端口，向服务器发送建立连接的请求；控制连接用于在服务器和客户端之间传输控制命令(即传递命令)；
- 第二个连接是FTP客户端和FTP服务器间的**数据连接**。FTP服务器使用TCP 20号端口与客户端建立数据连接(即上传和下载数据)； 

FTP客户端与FTP服务器建立连接时，客户进程将由本地主机上的TCP软件随机选取一个端口号。该端口号可选择的范围是1024～65535(非熟知端口号)； 

> Tips(关于端口号的定义)：TCP使用了端口号的概念来标识发送方和接收方的应用层，即端口号用来标识进程。根据Internet赋号管理局(Internet Assigned Numbers Authority，IANA)的定义，TCP端口号长度为16位，端口号的取值为0～65535之间的整数。
>
> TCP端口号分为**熟知端口号**(1～1023)、**注册端口号**(1024～49151)和**临时端口号**(49152～65535)。其中，熟知端口号被统一分配和控制，通常被用于系统级或根进程；注册端口号通常被用来作为终端用户连接服务器时短暂使用的源端口号，但它们也可以用来标识已被第三方注册了(或被命名)的服务；临时端口号可由任何进程随机选取使用。

### 2.5.3 FTP的工作方式

FTP有**PORT(主动式)**和**PASV(被动式)**两种工作方式。这里指的“主动”和“被动”，主要指是由客户端主动开放端口给服务器连接，还是由服务器主动开放端口给客户端连接。

- **PORT(主动式)**：客户端主动开放端口给服务器连接

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231017162117778.png" alt="image-20231017162117778" style="zoom:50%;" />

  - PORT(主动)方式的连接过程是：客户端使用随机端口(x)向服务器的FTP端口(默认是21)发送连接请求，服务器接受连接，建立一条命令链路；
  - 当需要传送数据时，客户端在这条命令链路上用PORT命令通知服务器：“我打开了某个端口(x+1)，你可以通过这个端口号来连接我”。于是服务器从20端口向客户端的指定开放端口(x+1)发送连接请求，以此建立一条数据链路来传送数据；

- **PASV(被动式)**：服务器主动开放端口给客户端连接

  <img src="C:\Users\ndream\AppData\Roaming\Typora\typora-user-images\image-20231017162409059.png" alt="image-20231017162409059" style="zoom:50%;" />

  - PASV(被动)方式的连接过程是：客户端向服务器的FTP端口(默认是21)发送连接请求，服务器接受连接，建立一条命令链路。在建立控制通道与主动模式相似，但建立连接后使用的是Pasv命令；

  - 当需要传送数据时，客户端向服务器端发送PASV命令，服务器在命令链路上收到命令后先随机打开一个端口号大于1024的端口，然后通知客户端：“我打开了某某端口，你过来连接我”；于是客户端向服务器的某某端口发送三次握手连接请求，建立一条数据链路来传送数据；

    > Tips：相比于主动模式(PORT)，由于被动模式(PASV)的命令连接和数据连接都是由客户端发起的，这样可以解决从服务器端到客户端的入方向上连接可能被防火墙过滤的问题。